{% extends 'base.html' %}
{% load static %}

{% block title %}Manager Dashboard - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    .manager-dashboard {
        padding: 2rem 0;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .management-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .pending-approvals {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .user-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .user-card:hover {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .user-details h6 {
        margin-bottom: 0.25rem;
        color: #2c3e50;
    }
    
    .user-details small {
        color: #6c757d;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-approve {
        background: #28a745;
        border-color: #28a745;
    }
    
    .btn-reject {
        background: #dc3545;
        border-color: #dc3545;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .quick-action {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        text-decoration: none;
        color: #2c3e50;
        transition: all 0.3s ease;
    }
    
    .quick-action:hover {
        border-color: #667eea;
        color: #667eea;
        text-decoration: none;
        transform: translateY(-2px);
    }
    
    .quick-action i {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: block;
    }

    /* Live Parking Slots Styles - Original Design */
    .parking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        padding: 2rem;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .parking-slot {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .parking-slot::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .parking-slot:hover::before {
        left: 100%;
    }

    .parking-slot.vacant {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
    }

    .parking-slot.occupied {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
    }

    .parking-slot.reserved {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
    }

    .parking-slot:hover {
        transform: translateY(-3px) scale(1.05);
    }

    .slot-id {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .slot-user {
        font-size: 0.75rem;
        font-weight: 500;
        margin-bottom: 2px;
        opacity: 0.9;
        line-height: 1.1;
        max-height: 2.2em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .slot-status {
        font-size: 0.7rem;
        font-weight: 600;
        opacity: 0.8;
    }

    /* Video Feed Styles */
    .video-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
    }

    .video-controls {
        margin-bottom: 1rem;
    }

    .video-feed {
        width: 100%;
        max-width: 800px;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .loading {
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced Stats Cards */
    .enhanced-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .enhanced-stats .stats-card {
        position: relative;
        overflow: hidden;
    }

    .enhanced-stats .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .enhanced-stats .stats-card:hover::before {
        left: 100%;
    }

    .trend-indicator {
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    .trend-up {
        color: #28a745;
    }

    .trend-down {
        color: #dc3545;
    }

    .trend-neutral {
        color: #6c757d;
    }

      /* Simple Live Update Styles */
    .connection-indicator {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        margin-left: 1rem;
        display: inline-block;
    }

    .connection-indicator.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .connection-indicator.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .connection-indicator.connecting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .loading-indicator {
        display: none;
        color: #007bff;
        margin-right: 0.5rem;
        font-size: 0.9rem;
    }
    
    /* Revenue Breakdown Styles */
    .revenue-breakdown {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        height: 100%;
    }
    
    .revenue-breakdown h5 {
        margin-bottom: 1.5rem;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .breakdown-item:last-child {
        border-bottom: none;
        padding-top: 1rem;
        margin-top: 0.5rem;
        border-top: 2px solid #667eea;
    }
    
    .breakdown-item.total {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .breakdown-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .breakdown-value {
        color: #2c3e50;
        font-weight: 600;
    }
    
    .breakdown-item.total .breakdown-label,
    .breakdown-item.total .breakdown-value {
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="container manager-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-tachometer-alt"></i> Manager Dashboard</h1>
                <p class="mb-0">Welcome back, {{ user.get_full_name|default:user.username }}! Manage your parking system efficiently.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="text-white-50">
                    <small>Last login: {{ user.last_login|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Stats Cards -->
    <div class="enhanced-stats">
        <div class="stats-card success">
            <h3 id="availableCount">{{ available_slots|default:0 }}</h3>
            <p><i class="fas fa-parking"></i> Available Slots</p>
            <div class="trend-indicator" id="availableTrend">
            </div>
        </div>
        <div class="stats-card danger">
            <h3 id="occupiedCount">{{ occupied_slots|default:0 }}</h3>
            <p><i class="fas fa-car"></i> Occupied Slots</p>
            <div class="trend-indicator" id="occupiedTrend">
            </div>
        </div>
        <div class="stats-card warning">
            <h3 id="reservedCount">{{ reserved_slots|default:0 }}</h3>
            <p><i class="fas fa-clock"></i> Reserved Slots</p>
            <div class="trend-indicator" id="reservedTrend">
            </div>
        </div>

        <div class="stats-card">
            <h3 id="todayRevenue">₹{{ today_revenue|floatformat:2 }}</h3>
            <p><i class="fas fa-rupee-sign"></i> Today's Revenue</p>
        </div>
        
        <div class="stats-card success">
            <h3 id="totalRevenue">₹{{ total_revenue|floatformat:2 }}</h3>
            <p><i class="fas fa-chart-line"></i> Lifetime Revenue</p>
        </div>
        
    </div>

    <!-- Revenue Analytics Quick Link -->
    <div class="management-section" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 style="color: white;"><i class="fas fa-chart-line"></i> Revenue Analytics</h3>
                <p class="mb-0">View detailed revenue reports, trends, and performance metrics</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{% url 'revenue_analytics' %}" class="btn btn-light btn-lg">
                    <i class="fas fa-chart-bar"></i> View Analytics
                </a>
            </div>
        </div>
    </div>

    <!-- Pending Approvals Section -->
    {% if pending_approvals %}
    <div class="management-section">
        <h3><i class="fas fa-user-check"></i> Pending User Approvals</h3>
        <div class="pending-approvals">
            {% for profile in pending_approvals %}
            <div class="user-card">
                <div class="user-info">
                    <div class="user-details">
                        <h6>{{ profile.user.get_full_name|default:profile.user.username }}</h6>
                        <small>{{ profile.user.email }} • {{ profile.get_user_type_display }} • Registered: {{ profile.created_at|date:"M d, Y" }}</small>
                        {% if profile.phone_number %}
                        <br><small><i class="fas fa-phone"></i> {{ profile.phone_number }}</small>
                        {% endif %}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-approve text-white" onclick="approveUser('{{ profile.user.id }}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-reject text-white" onclick="rejectUser('{{ profile.user.id }}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- User Management Summary -->
    <div class="row">
        <div class="col-md-6">
            <div class="management-section">
                <h4><i class="fas fa-users-cog"></i> User Management</h4>
                <div class="row text-center">
                    <div class="col-4">
                        <h5 class="text-primary">{{ customer_count }}</h5>
                        <small>Customers</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-info">{{ staff_count }}</h5>
                        <small>Staff</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-success">{{ manager_count }}</h5>
                        <small>Managers</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="management-section">
                <h4><i class="fas fa-chart-pie"></i> System Status</h4>
                <div class="row text-center">
                    <div class="col-4">
                        <h5 class="text-success">{{ occupied_slots }}</h5>
                        <small>Occupied</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-warning">{{ reserved_slots }}</h5>
                        <small>Reserved</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-info">{{ total_slots }}</h5>
                        <small>Total Slots</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'manager_user_management' %}" class="quick-action">
            <i class="fas fa-users-cog"></i>
            <h5>User Management</h5>
            <p>Manage users and approvals</p>
        </a>
        <a href="{% url 'staff_register' %}" class="quick-action">
            <i class="fas fa-user-tie"></i>
            <h5>Add Staff</h5>
            <p>Create new staff member</p>
        </a>
        <a href="{% url 'customer_register' %}" class="quick-action">
            <i class="fas fa-user-plus"></i>
            <h5>Add Customer</h5>
            <p>Register new customer</p>
        </a>
        <a href="{% url 'unified-parking-management' %}" class="quick-action">
            <i class="fas fa-parking"></i>
            <h5>Parking Management</h5>
            <p>Assign slots, view registry & lookup sessions</p>
        </a>
        <a href="{% url 'staff_bookings_list' %}" class="quick-action">
            <i class="fas fa-calendar-check"></i>
            <h5>Manage Bookings</h5>
            <p>View and manage reservations</p>
        </a>
        <a href="{% url 'end_session_by_vehicle' %}" class="quick-action">
            <i class="fas fa-sign-out-alt"></i>
            <h5>End Session</h5>
            <p>End parking session</p>
        </a>
        <a href="{% url 'history-log' %}" class="quick-action">
            <i class="fas fa-history"></i>
            <h5>System Logs</h5>
            <p>View system activity logs</p>
        </a>
        <a href="/admin/" class="quick-action">
            <i class="fas fa-database"></i>
            <h5>Django Admin</h5>
            <p>Advanced system management</p>
        </a>
    </div>

    <!-- Live Parking Slots Section -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-th-large"></i> Live Parking Slot Status
                <span class="badge bg-success ms-2" id="autoRefreshBadge">Auto-refresh ON</span>
            </div>
            <div>
                <button class="btn btn-sm btn-light" onclick="fetchSlots()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="parking-grid" id="slotGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Feed Section -->
    <div class="video-container">
        <h3><i class="fas fa-video"></i> Live Camera Feed</h3>
        <div class="video-controls">
            <button class="btn btn-primary" onclick="toggleFeed()">
                <i class="fas fa-play"></i> Show Feed
            </button>
            <button class="btn btn-secondary" onclick="refreshFeed()" style="display:none;" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div id="videoArea" style="display:none; margin-top: 20px;">
            <img id="liveFeed" src="{% url 'video_feed' %}" class="video-feed" />
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Global variables for live features
let autoRefreshEnabled = true;
let refreshInterval;
let retryCount = 0;
let lastSlotData = new Map();
let connectionStatus = 'connecting';
let isUpdating = false; // Prevent concurrent updates

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    startAutoRefresh();
    // Don't auto-start video feed - let user choose
    console.log('Manager dashboard initialized');
});

function initializeDashboard() {
    fetchSlots();
}

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);

    refreshInterval = setInterval(() => {
        if (autoRefreshEnabled) {
            fetchSlots();
        }
    }, 10000); // Refresh every 10 seconds (reduced from 3 seconds)
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const badge = document.getElementById('autoRefreshBadge');
    const icon = document.getElementById('autoRefreshIcon');
    const text = document.getElementById('autoRefreshText');

    if (autoRefreshEnabled) {
        badge.textContent = 'Auto-refresh ON';
        badge.className = 'badge bg-success ms-2';
        icon.className = 'fas fa-pause';
        text.textContent = 'Pause';
    } else {
        badge.textContent = 'Auto-refresh OFF';
        badge.className = 'badge bg-danger ms-2';
        icon.className = 'fas fa-play';
        text.textContent = 'Resume';
    }
}

function fetchSlots() {
    if (isUpdating) return; // Prevent concurrent updates

    isUpdating = true;
    const startTime = performance.now();
    showLoadingIndicator();

    fetch('/api/slot-status/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const endTime = performance.now();
            const responseTime = Math.round(endTime - startTime);

            updateSlotGrid(data);
            updateConnectionStatus('connected', responseTime);
            hideLoadingIndicator();
            retryCount = 0; // Reset retry count on success
            isUpdating = false; // Allow next update
        })
        .catch(error => {
            console.error('Error fetching slots:', error);
            updateConnectionStatus('error', null);
            hideLoadingIndicator();

            const grid = document.getElementById('slotGrid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<div class="alert alert-danger">Error loading slot data. Retrying...</div>';
            }

            // Retry with exponential backoff
            retryCount++;
            const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 10000);
            isUpdating = false; // Allow retry
            setTimeout(() => {
                if (autoRefreshEnabled) {
                    fetchSlots();
                }
            }, retryDelay);
        });
}

function updateSlotGrid(data) {
    const grid = document.getElementById('slotGrid');
    const newSlotData = new Map();

    // Check if data has actually changed to avoid unnecessary DOM updates
    let hasChanges = false;
    data.forEach(slot => {
        const slotKey = slot.slot_id;
        const currentStatus = `${slot.is_occupied}-${slot.is_reserved}-${slot.session_status}-${slot.user_info ? slot.user_info.name : ''}`;
        newSlotData.set(slotKey, currentStatus);

        if (!lastSlotData.has(slotKey) || lastSlotData.get(slotKey) !== currentStatus) {
            hasChanges = true;
        }
    });

    // Only update DOM if there are actual changes
    if (!hasChanges && lastSlotData.size === newSlotData.size) {
        return;
    }

    // Clear grid only when necessary
    grid.innerHTML = '';

    data.forEach(slot => {
        const slotKey = slot.slot_id;
        const currentStatus = `${slot.is_occupied}-${slot.is_reserved}-${slot.session_status}`;
        newSlotData.set(slotKey, currentStatus);

        const div = document.createElement('div');
        div.classList.add('parking-slot');

        let status, statusClass, tooltip = '';
        let displayInfo = '';

        if (slot.session_status === 'pending' || slot.is_reserved) {
            status = 'Reserved';
            statusClass = 'reserved';
            if (slot.vehicle_number) {
                if (slot.user_info && slot.user_info.name) {
                    displayInfo = slot.user_info.name;
                    tooltip = `Owner: ${slot.user_info.name}\nVehicle: ${slot.vehicle_number}`;
                    if (slot.user_info.phone) {
                        tooltip += `\nPhone: ${slot.user_info.phone}`;
                    }
                    if (slot.vehicle_info && (slot.vehicle_info.make || slot.vehicle_info.model)) {
                        tooltip += `\nVehicle: ${slot.vehicle_info.year || ''} ${slot.vehicle_info.make || ''} ${slot.vehicle_info.model || ''}`.trim();
                    }
                } else {
                    displayInfo = slot.vehicle_number;
                    tooltip = `Vehicle: ${slot.vehicle_number} (Unregistered)`;
                }
            }
        } else if (slot.is_occupied) {
            status = 'Occupied';
            statusClass = 'occupied';
            if (slot.vehicle_number) {
                if (slot.user_info && slot.user_info.name) {
                    displayInfo = slot.user_info.name;
                    tooltip = `Owner: ${slot.user_info.name}\nVehicle: ${slot.vehicle_number}`;
                    if (slot.user_info.phone) {
                        tooltip += `\nPhone: ${slot.user_info.phone}`;
                    }
                    if (slot.vehicle_info && (slot.vehicle_info.make || slot.vehicle_info.model)) {
                        tooltip += `\nVehicle: ${slot.vehicle_info.year || ''} ${slot.vehicle_info.make || ''} ${slot.vehicle_info.model || ''}`.trim();
                    }
                } else {
                    displayInfo = slot.vehicle_number;
                    tooltip = `Vehicle: ${slot.vehicle_number} (Unregistered)`;
                }
                if (slot.session_start) {
                    const startTime = new Date(slot.session_start);
                    const duration = Math.floor((new Date() - startTime) / (1000 * 60));
                    tooltip += `\nDuration: ${duration} min`;
                }
            }
        } else {
            status = 'Available';
            statusClass = 'vacant';
            tooltip = 'Available for assignment';
        }

        // Check if status changed
        const wasChanged = lastSlotData.has(slotKey) &&
                          lastSlotData.get(slotKey) !== currentStatus;

        div.classList.add(statusClass);
        if (wasChanged) {
            div.classList.add('slot-updated');
            // Remove animation class after animation
            setTimeout(() => {
                div.classList.remove('slot-updated');
            }, 1000);
        }

        div.title = tooltip;

        // Create slot content with user-friendly display
        let slotContent = `<div class="slot-id">${slot.slot_id}</div>`;
        if (displayInfo) {
            slotContent += `<div class="slot-user">${displayInfo}</div>`;
        }
        slotContent += `<div class="slot-status">${status}</div>`;
        if (wasChanged) {
            slotContent += '<div class="update-pulse"></div>';
        }

        div.innerHTML = slotContent;

        grid.appendChild(div);
    });

    // Update stored data for next comparison
    lastSlotData = newSlotData;

    // Update stats
    updateStats(data);
}

function updateStats(data) {
    const stats = {
        available: data.filter(s => !s.is_occupied && !s.is_reserved && s.session_status !== 'pending').length,
        occupied: data.filter(s => s.is_occupied).length,
        reserved: data.filter(s => s.is_reserved || s.session_status === 'pending').length,
        total: data.length
    };

    animateStatChange('availableCount', stats.available);
    animateStatChange('occupiedCount', stats.occupied);
    animateStatChange('reservedCount', stats.reserved);
    animateStatChange('totalCount', stats.total);
}

function animateStatChange(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;

    const currentValue = parseInt(element.textContent) || 0;

    if (currentValue !== newValue) {
        element.classList.add('stat-updated');
        element.textContent = newValue;

        setTimeout(() => {
            element.classList.remove('stat-updated');
        }, 500);
    }
}

function updateConnectionStatus(status, responseTime) {
    const indicator = document.getElementById('connectionIndicator') || createConnectionIndicator();
    const now = new Date().toLocaleTimeString();

    connectionStatus = status;

    if (status === 'connected') {
        indicator.className = 'connection-indicator connected';
        indicator.innerHTML = `<i class="fas fa-wifi"></i> Live (${responseTime}ms) - ${now}`;
    } else if (status === 'error') {
        indicator.className = 'connection-indicator error';
        indicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Connection Error - ${now}`;
    } else {
        indicator.className = 'connection-indicator connecting';
        indicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Connecting...`;
    }
}

function createConnectionIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'connectionIndicator';
    indicator.className = 'connection-indicator connecting';

    // Add to dashboard header
    const header = document.querySelector('.card-header h4');
    if (header) {
        header.appendChild(indicator);
    }

    return indicator;
}

function showLoadingIndicator() {
    const indicator = document.getElementById('loadingIndicator') || createLoadingIndicator();
    indicator.style.display = 'block';
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

function createLoadingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'loadingIndicator';
    indicator.className = 'loading-indicator';
    indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';

    const refreshBtn = document.querySelector('button[onclick="fetchSlots()"]');
    if (refreshBtn) {
        refreshBtn.parentNode.insertBefore(indicator, refreshBtn);
    }

    return indicator;
}

function toggleFeed() {
    const videoArea = document.getElementById('videoArea');
    const refreshBtn = document.getElementById('refreshBtn');
    const toggleBtn = event.target;

    if (videoArea.style.display === 'none') {
        videoArea.style.display = 'block';
        refreshBtn.style.display = 'inline-block';
        toggleBtn.innerHTML = '<i class="fas fa-pause"></i> Hide Feed';
        toggleBtn.className = 'btn btn-danger';
    } else {
        videoArea.style.display = 'none';
        refreshBtn.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-play"></i> Show Feed';
        toggleBtn.className = 'btn btn-primary';
    }
}

function refreshFeed() {
    const liveFeed = document.getElementById('liveFeed');
    const currentSrc = liveFeed.src;
    liveFeed.src = '';
    setTimeout(() => {
        liveFeed.src = currentSrc + '?t=' + new Date().getTime();
    }, 100);
}

// User approval functions
function approveUser(userId) {
    if (confirm('Are you sure you want to approve this user?')) {
        fetch(`/manager/approve-user/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while approving the user.');
        });
    }
}

function rejectUser(userId) {
    const reason = prompt('Please provide a reason for rejection (optional):');
    if (reason !== null) {
        fetch(`/manager/reject-user/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({reason: reason})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while rejecting the user.');
        });
    }
}

// Auto-refresh functionality temporarily disabled
// TODO: Re-enable when user management APIs are restored

console.log('Manager dashboard loaded successfully');
{% endblock %}

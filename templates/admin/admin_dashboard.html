{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    .admin-dashboard {
        padding: 2rem 0;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .management-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .pending-approvals {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .user-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .user-card:hover {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .user-details h6 {
        margin-bottom: 0.25rem;
        color: #2c3e50;
    }
    
    .user-details small {
        color: #6c757d;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-approve {
        background: #28a745;
        border-color: #28a745;
    }
    
    .btn-reject {
        background: #dc3545;
        border-color: #dc3545;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .quick-action {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        text-decoration: none;
        color: #2c3e50;
        transition: all 0.3s ease;
    }
    
    .quick-action:hover {
        border-color: #667eea;
        color: #667eea;
        text-decoration: none;
        transform: translateY(-2px);
    }
    
    .quick-action i {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container admin-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                <p class="mb-0">Welcome back, {{ user.get_full_name|default:user.username }}! Manage your parking system efficiently.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="text-white-50">
                    <small>Last login: {{ user.last_login|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon text-primary">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-number text-primary">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon text-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-number text-warning">{{ pending_approvals_count }}</div>
            <div class="stat-label">Pending Approvals</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon text-success">
                <i class="fas fa-parking"></i>
            </div>
            <div class="stat-number text-success">{{ available_slots }}</div>
            <div class="stat-label">Available Slots</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon text-info">
                <i class="fas fa-car"></i>
            </div>
            <div class="stat-number text-info">{{ active_sessions }}</div>
            <div class="stat-label">Active Sessions</div>
        </div>
    </div>

    <!-- Pending Approvals Section -->
    {% if pending_approvals %}
    <div class="management-section">
        <h3><i class="fas fa-user-check"></i> Pending User Approvals</h3>
        <div class="pending-approvals">
            {% for profile in pending_approvals %}
            <div class="user-card">
                <div class="user-info">
                    <div class="user-details">
                        <h6>{{ profile.user.get_full_name|default:profile.user.username }}</h6>
                        <small>{{ profile.user.email }} • {{ profile.get_user_type_display }} • Registered: {{ profile.created_at|date:"M d, Y" }}</small>
                        {% if profile.phone_number %}
                        <br><small><i class="fas fa-phone"></i> {{ profile.phone_number }}</small>
                        {% endif %}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-approve text-white" onclick="approveUser('{{ profile.user.id }}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-reject text-white" onclick="rejectUser('{{ profile.user.id }}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- User Management Summary -->
    <div class="row">
        <div class="col-md-6">
            <div class="management-section">
                <h4><i class="fas fa-users-cog"></i> User Management</h4>
                <div class="row text-center">
                    <div class="col-4">
                        <h5 class="text-primary">{{ customer_count }}</h5>
                        <small>Customers</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-info">{{ staff_count }}</h5>
                        <small>Staff</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-success">{{ manager_count }}</h5>
                        <small>Managers</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="management-section">
                <h4><i class="fas fa-chart-pie"></i> System Status</h4>
                <div class="row text-center">
                    <div class="col-4">
                        <h5 class="text-success">{{ occupied_slots }}</h5>
                        <small>Occupied</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-warning">{{ reserved_slots }}</h5>
                        <small>Reserved</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-info">{{ total_slots }}</h5>
                        <small>Total Slots</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'manager_user_management' %}" class="quick-action">
            <i class="fas fa-users-cog"></i>
            <h5>Manage Users</h5>
            <p>View and manage all users</p>
        </a>
        <a href="{% url 'manager_create_staff' %}" class="quick-action">
            <i class="fas fa-user-plus"></i>
            <h5>Create Staff</h5>
            <p>Add new staff members</p>
        </a>
        <a href="{% url 'manager_system_settings' %}" class="quick-action">
            <i class="fas fa-cogs"></i>
            <h5>System Settings</h5>
            <p>Configure system parameters</p>
        </a>
        <a href="{% url 'history-log' %}" class="quick-action">
            <i class="fas fa-history"></i>
            <h5>System Logs</h5>
            <p>View system activity logs</p>
        </a>
        <a href="{% url 'security_dashboard' %}" class="quick-action">
            <i class="fas fa-shield-alt"></i>
            <h5>Security</h5>
            <p>Monitor security events</p>
        </a>
        <a href="/admin/" class="quick-action">
            <i class="fas fa-database"></i>
            <h5>Django Admin</h5>
            <p>Advanced system management</p>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// User approval functions
function approveUser(userId) {
    if (confirm('Are you sure you want to approve this user?')) {
        fetch(`/admin/approve-user/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while approving the user.');
        });
    }
}

function rejectUser(userId) {
    const reason = prompt('Please provide a reason for rejection (optional):');
    if (reason !== null) {
        fetch(`/admin/reject-user/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({reason: reason})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while rejecting the user.');
        });
    }
}

// Auto-refresh pending approvals count
setInterval(() => {
    fetch('/api/pending-approvals-count/')
        .then(response => response.json())
        .then(data => {
            const countElement = document.querySelector('.stat-number.text-warning');
            if (countElement && data.count !== undefined) {
                countElement.textContent = data.count;
            }
        })
        .catch(error => console.error('Error fetching pending approvals:', error));
}, 30000); // Refresh every 30 seconds
{% endblock %}

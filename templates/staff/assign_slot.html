{% extends 'base.html' %}
{% load static %}

{% block title %}Assign Parking Slot - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Assign Parking Slot</h2>
                </div>
                <div class="card-body">
                    {% if error %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                        </div>
                    {% endif %}

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="{{ form.vehicle_number.id_for_label }}" class="form-label">
                                <i class="fas fa-car"></i> Vehicle Number
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="{{ form.vehicle_number.id_for_label }}"
                                   name="{{ form.vehicle_number.name }}"
                                   placeholder="Enter vehicle number (e.g., ABC-1234)"
                                   required
                                   style="text-transform: uppercase;">
                            <div class="invalid-feedback">
                                Please provide a valid vehicle number.
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="zone_preference" class="form-label">
                                <i class="fas fa-layer-group"></i> Zone Preference
                            </label>
                            <select class="form-control" id="zone_preference" name="zone_preference">
                                <option value="">Auto-select best zone</option>
                                {% for zone in zones %}
                                    <option value="{{ zone }}">Zone {{ zone }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                Leave blank for automatic zone selection based on availability.
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check"></i> Assign Slot
                            </button>
                            <a href="/staff/dashboard/" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Available Slots Info -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-info-circle"></i> Available Slots</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshAvailableSlots()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="availableSlots">
                        {% if available_slots %}
                            {% for slot in available_slots %}
                                <div class="col-md-2 col-sm-3 col-4 mb-2">
                                    <div class="parking-slot vacant small">
                                        <div class="slot-id">{{ slot.slot_id }}</div>
                                        <div class="slot-status">Zone {{ slot.zone }}</div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12 text-center">
                                <div class="spinner"></div>
                                <p>Loading available slots...</p>
                            </div>
                        {% endif %}
                    </div>

                    {% if available_slots %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Total available slots: {{ available_slots|length }}
                                {% if zones %}
                                    | Zones: {% for zone in zones %}Zone {{ zone }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Load available slots
function loadAvailableSlots() {
    fetch('/api/slot-status/')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('availableSlots');
            const availableSlots = data.filter(slot => !slot.is_occupied && !slot.is_reserved);

            if (availableSlots.length === 0) {
                container.innerHTML = '<div class="col-12 text-center"><div class="alert alert-warning">No slots available at the moment</div></div>';
                return;
            }

            container.innerHTML = '';
            availableSlots.forEach(slot => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'col-md-2 col-sm-3 col-4 mb-2';
                slotDiv.innerHTML = `
                    <div class="parking-slot vacant small">
                        <div class="slot-id">${slot.slot_id}</div>
                        <div class="slot-status">Available</div>
                    </div>
                `;
                container.appendChild(slotDiv);
            });
        })
        .catch(error => {
            console.error('Error loading slots:', error);
            document.getElementById('availableSlots').innerHTML =
                '<div class="col-12"><div class="alert alert-danger">Error loading slot information</div></div>';
        });
}

// Auto-uppercase vehicle number input
document.addEventListener('DOMContentLoaded', function() {
    const vehicleInput = document.querySelector('input[name="vehicle_number"]');
    if (vehicleInput) {
        vehicleInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }

    // Only load if slots aren't already loaded from server
    if (!document.querySelector('.parking-slot')) {
        loadAvailableSlots();
    }

    // Auto-refresh every 10 seconds
    setInterval(loadAvailableSlots, 10000);
});

function refreshAvailableSlots() {
    loadAvailableSlots();
}
{% endblock %}

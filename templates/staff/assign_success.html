{% extends 'base.html' %}
{% load static %}

{% block title %}Slot Assigned Successfully - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    .success-container {
        max-width: 600px;
        margin: 2rem auto;
    }
    
    .success-icon {
        font-size: 4rem;
        color: #28a745;
        margin-bottom: 1rem;
    }
    
    .assignment-details {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        opacity: 0.9;
    }
    
    .detail-value {
        font-size: 1.1rem;
        font-weight: 700;
    }
    
    .zone-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .auto-assigned-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="success-container">
        <!-- Success Header -->
        <div class="text-center">
            <i class="fas fa-check-circle success-icon"></i>
            <h2 class="text-success mb-3">Slot Assigned Successfully!</h2>
            {% if auto_assigned %}
                <div class="auto-assigned-badge">
                    <i class="fas fa-robot"></i> Automatically Assigned
                </div>
            {% endif %}
        </div>

        <!-- Assignment Details -->
        <div class="assignment-details">
            <h4 class="mb-4">
                <i class="fas fa-parking"></i> Assignment Details
            </h4>
            
            <div class="detail-item">
                <span class="detail-label">
                    <i class="fas fa-car"></i> Vehicle Number
                </span>
                <span class="detail-value">{{ session.vehicle_number }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">
                    <i class="fas fa-map-marker-alt"></i> Assigned Slot
                </span>
                <span class="detail-value">{{ session.slot.slot_id }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">
                    <i class="fas fa-layer-group"></i> Zone
                </span>
                <span class="detail-value">
                    <span class="zone-badge">Zone {{ zone }}</span>
                </span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">
                    <i class="fas fa-clock"></i> Reserved At
                </span>
                <span class="detail-value">{{ session.created_at|date:"M d, Y H:i" }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">
                    <i class="fas fa-flag"></i> Status
                </span>
                <span class="detail-value">
                    <span class="badge bg-warning" id="sessionStatus">{{ session.status|title }}</span>
                </span>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Next Steps</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">For the Driver:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-primary"></i> Proceed to Zone {{ zone }}</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> Park in Slot {{ session.slot.slot_id }}</li>
                            <li><i class="fas fa-arrow-right text-primary"></i> Session will activate automatically</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info">Important Notes:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-clock text-info"></i> Slot reserved for 15 minutes</li>
                            <li><i class="fas fa-camera text-info"></i> OpenCV will detect arrival</li>
                            <li><i class="fas fa-rupee-sign text-info"></i> Billing starts on arrival</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-3 justify-content-center mt-4">
            <a href="{% url 'assign-slot' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Assign Another Slot
            </a>
            <a href="/staff/dashboard/" class="btn btn-secondary">
                <i class="fas fa-tachometer-alt"></i> Back to Dashboard
            </a>
            <a href="/customer/lookup/" class="btn btn-info">
                <i class="fas fa-search"></i> Vehicle Lookup
            </a>
        </div>

        <!-- QR Code Section (Future Enhancement) -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-qrcode"></i> Quick Access</h6>
            </div>
            <div class="card-body text-center">
                <p class="text-muted">
                    Vehicle Number: <strong>{{ session.vehicle_number }}</strong><br>
                    Session ID: <strong>{{ session.id }}</strong>
                </p>
                <small class="text-muted">
                    Use this information for quick vehicle lookup or session management.
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Auto-refresh to check if session becomes active
let checkCount = 0;
const maxChecks = 20; // Check for 10 minutes (30s intervals)

function checkSessionStatus() {
    if (checkCount >= maxChecks) return;
    
    fetch(`/api/session-status/{{ session.id }}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'active') {
                // Session is now active, show notification
                if (window.showSuccess) {
                    window.showSuccess('Vehicle detected! Session is now active.', {
                        title: 'Session Activated',
                        browser: true
                    });
                }
                
                // Update the status badge
                const statusBadge = document.getElementById('sessionStatus');
                if (statusBadge) {
                    statusBadge.textContent = 'Active';
                    statusBadge.className = 'badge bg-success';
                }
            }
        })
        .catch(error => {
            console.error('Error checking session status:', error);
        });
    
    checkCount++;
}

// Check session status every 30 seconds
setInterval(checkSessionStatus, 30000);

// Show success notification
document.addEventListener('DOMContentLoaded', function() {
    if (window.showSuccess) {
        window.showSuccess('{{ message }}', {
            title: 'Slot Assignment',
            browser: false
        });
    }
});
{% endblock %}

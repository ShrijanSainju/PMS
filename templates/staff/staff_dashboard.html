{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Dashboard - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block main_class %}d-flex{% endblock %}

{% block content %}
<!-- Sidebar -->
<div class="sidebar">
    <h2><i class="fas fa-user-tie"></i> Staff Panel</h2>
    <ul>
        <li><a href="/staff/assign/"><i class="fas fa-plus-circle"></i> Assign Slot</a></li>
        <li><a href="/staff/end-by-vehicle/"><i class="fas fa-sign-out-alt"></i> End Session</a></li>
        <li><a href="/customer/lookup/"><i class="fas fa-search"></i> Lookup Vehicle</a></li>
        <li><a href="/history/"><i class="fas fa-history"></i> Session History</a></li>
        <li><a href="/dashboard/"><i class="fas fa-tachometer-alt"></i> Live Dashboard</a></li>
        <li><a href="/admin/"><i class="fas fa-cog"></i> Admin Panel</a></li>
    </ul>
</div>
<!-- Main Content -->
<div class="main-content">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="fas fa-user-tie"></i> Staff Dashboard</h1>
        <p>Welcome, {{ user.username }}! Manage parking operations efficiently.</p>
    </div>

    <!-- Quick Stats -->
    <div class="dashboard-grid">
        <div class="stats-card success">
            <h3 id="availableSlots">0</h3>
            <p><i class="fas fa-parking"></i> Available Slots</p>
        </div>
        <div class="stats-card warning">
            <h3 id="activeSessions">0</h3>
            <p><i class="fas fa-car"></i> Active Sessions</p>
        </div>
        <div class="stats-card">
            <h3 id="todayRevenue">₹0</h3>
            <p><i class="fas fa-rupee-sign"></i> Today's Revenue</p>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="/staff/assign/" class="quick-action">
            <i class="fas fa-plus-circle"></i>
            <h4>Assign Slot</h4>
            <p>Assign parking slot to new vehicle</p>
        </a>
        <a href="/staff/end-by-vehicle/" class="quick-action">
            <i class="fas fa-sign-out-alt"></i>
            <h4>End Session</h4>
            <p>Complete parking session and calculate fee</p>
        </a>
        <a href="/customer/lookup/" class="quick-action">
            <i class="fas fa-search"></i>
            <h4>Vehicle Lookup</h4>
            <p>Search for vehicle information</p>
        </a>
        <a href="/dashboard/" class="quick-action">
            <i class="fas fa-tachometer-alt"></i>
            <h4>Live Dashboard</h4>
            <p>View real-time parking status</p>
        </a>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <h3><i class="fas fa-clock"></i> Recent Activity</h3>
        <div id="recentActivity">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Initialize staff dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadStaffDashboard();
    startStaffAutoRefresh();
});

function loadStaffDashboard() {
    fetchLiveStats();
    fetchRecentActivity();
}

function startStaffAutoRefresh() {
    setInterval(() => {
        fetchLiveStats();
        fetchRecentActivity();
    }, 5000); // Refresh every 5 seconds
}

function fetchLiveStats() {
    fetch('/api/live-stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('availableSlots').textContent = data.available_slots || 0;
            document.getElementById('activeSessions').textContent = data.active_sessions || 0;
            document.getElementById('todayRevenue').textContent = '₹' + (data.today_revenue || 0);
        })
        .catch(error => {
            console.error('Error fetching live stats:', error);
        });
}

function fetchRecentActivity() {
    fetch('/api/dashboard-analytics/')
        .then(response => response.json())
        .then(data => {
            updateRecentActivity(data.recent_activity);
        })
        .catch(error => {
            console.error('Error fetching recent activity:', error);
        });
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivity');
    if (!activities || activities.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
        return;
    }

    container.innerHTML = '';
    activities.slice(0, 5).forEach(activity => { // Show only 5 recent activities
        const item = document.createElement('div');
        item.className = 'activity-item';

        let iconClass, iconType;
        if (activity.status === 'active') {
            iconClass = 'success';
            iconType = 'fas fa-sign-in-alt';
        } else if (activity.status === 'completed') {
            iconClass = 'danger';
            iconType = 'fas fa-sign-out-alt';
        } else {
            iconClass = 'warning';
            iconType = 'fas fa-clock';
        }

        const startTime = activity.start_time ? new Date(activity.start_time).toLocaleTimeString() : '--';
        const fee = activity.fee ? `₹${activity.fee}` : '--';

        item.innerHTML = `
            <div class="activity-icon ${iconClass}">
                <i class="${iconType}"></i>
            </div>
            <div class="activity-content">
                <h5>${activity.vehicle_number}</h5>
                <p>Slot ${activity.slot_id} • ${activity.status} • ${fee}</p>
            </div>
            <div class="activity-time">
                ${startTime}
            </div>
        `;

        container.appendChild(item);
    });
}
{% endblock %}

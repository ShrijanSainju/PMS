{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Operations Center - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    .staff-dashboard {
        padding: 1rem 0;
        background: #f8f9fa;
    }

    .operations-header {
        background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(253, 126, 20, 0.3);
    }

    .operations-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .quick-ops {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .op-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        color: #495057;
    }

    .op-card:hover {
        border-color: #fd7e14;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(253, 126, 20, 0.2);
        text-decoration: none;
        color: #fd7e14;
    }

    .op-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: #fd7e14;
    }

    .op-card:hover .op-icon {
        color: #e83e8c;
    }

    .management-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .customer-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .customer-card:hover {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .customer-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .customer-details h6 {
        margin-bottom: 0.25rem;
        color: #2c3e50;
    }

    .customer-details small {
        color: #6c757d;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .quick-action {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        text-decoration: none;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .quick-action:hover {
        border-color: #28a745;
        color: #28a745;
        text-decoration: none;
        transform: translateY(-2px);
    }

    .quick-action i {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: block;
    }

    /* Live Parking Slots Styles - Original Design */
    .parking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        padding: 2rem;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .parking-slot {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .parking-slot::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .parking-slot:hover::before {
        left: 100%;
    }

    .parking-slot.vacant {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
    }

    .parking-slot.occupied {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
    }

    .parking-slot.reserved {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
    }

    .parking-slot:hover {
        transform: translateY(-3px) scale(1.05);
    }

    .slot-id {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 2px;
    }

    .slot-user {
        font-size: 0.75rem;
        font-weight: 500;
        margin-bottom: 2px;
        opacity: 0.9;
        line-height: 1.1;
        max-height: 2.2em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .slot-status {
        font-size: 0.7rem;
        font-weight: 600;
        opacity: 0.8;
    }

    .slot-id {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .slot-status {
        font-size: 0.8rem;
        opacity: 0.9;
    }

    /* Video Feed Styles */
    .video-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
    }

    .video-controls {
        margin-bottom: 1rem;
    }

    .video-feed {
        width: 100%;
        max-width: 800px;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .loading {
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #fd7e14;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced Stats Cards */
    .enhanced-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .enhanced-stats .stats-card {
        position: relative;
        overflow: hidden;
    }

    .enhanced-stats .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .enhanced-stats .stats-card:hover::before {
        left: 100%;
    }

    .trend-indicator {
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    .trend-up {
        color: #28a745;
    }

    .trend-down {
        color: #dc3545;
    }

    .trend-neutral {
        color: #6c757d;
    }

    /* Simple Live Update Styles */
    .connection-indicator {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        margin-left: 1rem;
        display: inline-block;
    }

    .connection-indicator.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .connection-indicator.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .connection-indicator.connecting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .loading-indicator {
        display: none;
        color: #007bff;
        margin-right: 0.5rem;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container staff-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-user-tie"></i> Staff Dashboard</h1>
                <p class="mb-0">Welcome back, {{ user.get_full_name|default:user.username }}! Manage customers and parking operations.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="text-white-50">
                    <small>Last login: {{ user.last_login|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Stats Cards -->
    <div class="enhanced-stats">
        <div class="stats-card success">
            <h3 id="availableCount">{{ available_slots|default:0 }}</h3>
            <p><i class="fas fa-parking"></i> Available Slots</p>
            <div class="trend-indicator" id="availableTrend">
                <i class="fas fa-minus"></i> No change
            </div>
        </div>
        <div class="stats-card danger">
            <h3 id="occupiedCount">{{ occupied_slots|default:0 }}</h3>
            <p><i class="fas fa-car"></i> Occupied Slots</p>
            <div class="trend-indicator" id="occupiedTrend">
                <i class="fas fa-minus"></i> No change
            </div>
        </div>
        <div class="stats-card warning">
            <h3 id="reservedCount">{{ reserved_slots|default:0 }}</h3>
            <p><i class="fas fa-clock"></i> Reserved Slots</p>
            <div class="trend-indicator" id="reservedTrend">
                <i class="fas fa-minus"></i> No change
            </div>
        </div>

        <div class="stats-card">
            <h3 id="customerCount">{{ customer_count|default:0 }}</h3>
            <p><i class="fas fa-users"></i> Total Customers</p>
            <div class="trend-indicator" id="customerTrend">
                <i class="fas fa-minus"></i> No change
            </div>
        </div>
        <div class="stats-card">
            <h3 id="pendingCustomersCount">{{ pending_customers_count|default:0 }}</h3>
            <p><i class="fas fa-user-clock"></i> Pending Customers</p>
            <div class="trend-indicator" id="pendingTrend">
                <i class="fas fa-minus"></i> No change
            </div>
        </div>
    </div>

    <!-- Pending Customer Approvals -->
    {% if pending_customers %}
    <div class="management-section">
        <h3><i class="fas fa-user-check"></i> Pending Customer Approvals</h3>
        <div class="pending-customers">
            {% for profile in pending_customers %}
            <div class="customer-card">
                <div class="customer-info">
                    <div class="customer-details">
                        <h6>{{ profile.user.get_full_name|default:profile.user.username }}</h6>
                        <small>{{ profile.user.email }} â€¢ Registered: {{ profile.created_at|date:"M d, Y" }}</small>
                        {% if profile.phone_number %}
                        <br><small><i class="fas fa-phone"></i> {{ profile.phone_number }}</small>
                        {% endif %}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="approveCustomer('{{ profile.user.id }}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectCustomer('{{ profile.user.id }}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'customer_register' %}" class="quick-action">
            <i class="fas fa-user-plus"></i>
            <h5>Add Customer</h5>
            <p>Register new customer</p>
        </a>
        <a href="{% url 'unified-parking-management' %}" class="quick-action">
            <i class="fas fa-parking"></i>
            <h5>Parking Management</h5>
            <p>Assign slots, view registry & lookup sessions</p>
        </a>
        <a href="{% url 'staff_bookings_list' %}" class="quick-action">
            <i class="fas fa-calendar-check"></i>
            <h5>Manage Bookings</h5>
            <p>View and manage reservations</p>
        </a>
        <a href="{% url 'end_session_by_vehicle' %}" class="quick-action">
            <i class="fas fa-sign-out-alt"></i>
            <h5>End Session</h5>
            <p>End parking session</p>
        </a>
        <a href="{% url 'staff_customer_management' %}" class="quick-action">
            <i class="fas fa-users-cog"></i>
            <h5>Customer Management</h5>
            <p>Find customer vehicles</p>
        </a>
        <a href="{% url 'history-log' %}" class="quick-action">
            <i class="fas fa-history"></i>
            <h5>View History</h5>
            <p>Parking session logs</p>
        </a>
    </div>

    <!-- Live Parking Slots Section -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-th-large"></i> Live Parking Slot Status
                <span class="badge bg-success ms-2" id="autoRefreshBadge">Auto-refresh ON</span>
            </div>
            <div>
                <button class="btn btn-sm btn-light" onclick="fetchSlots()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="parking-grid" id="slotGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Feed Section -->
    <div class="video-container">
        <h3><i class="fas fa-video"></i> Live Camera Feed</h3>
        <div class="video-controls">
            <button class="btn btn-primary" onclick="toggleFeed()">
                <i class="fas fa-play"></i> Show Feed
            </button>
            <button class="btn btn-secondary" onclick="refreshFeed()" style="display:none;" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div id="videoArea" style="display:none; margin-top: 20px;">
            <img id="liveFeed" src="{% url 'video_feed' %}" class="video-feed" />
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Global variables for live features
let autoRefreshEnabled = true;
let refreshInterval;
let retryCount = 0;
let lastSlotData = new Map();
let connectionStatus = 'connecting';

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    startAutoRefresh();
    // Auto-start video feed for detection
    toggleFeed();
});

function initializeDashboard() {
    fetchSlots();
}

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);

    refreshInterval = setInterval(() => {
        if (autoRefreshEnabled) {
            fetchSlots();
        }
    }, 3000); // Refresh every 3 seconds
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const badge = document.getElementById('autoRefreshBadge');
    const icon = document.getElementById('autoRefreshIcon');
    const text = document.getElementById('autoRefreshText');

    if (autoRefreshEnabled) {
        badge.textContent = 'Auto-refresh ON';
        badge.className = 'badge bg-success ms-2';
        icon.className = 'fas fa-pause';
        text.textContent = 'Pause';
    } else {
        badge.textContent = 'Auto-refresh OFF';
        badge.className = 'badge bg-danger ms-2';
        icon.className = 'fas fa-play';
        text.textContent = 'Resume';
    }
}

function fetchSlots() {
    const startTime = performance.now();
    showLoadingIndicator();

    fetch('/api/slot-status/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const endTime = performance.now();
            const responseTime = Math.round(endTime - startTime);

            updateSlotGrid(data);
            updateConnectionStatus('connected', responseTime);
            hideLoadingIndicator();
            retryCount = 0; // Reset retry count on success
        })
        .catch(error => {
            console.error('Error fetching slots:', error);
            updateConnectionStatus('error', null);
            hideLoadingIndicator();

            const grid = document.getElementById('slotGrid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<div class="alert alert-danger">Error loading slot data. Retrying...</div>';
            }

            // Retry with exponential backoff
            retryCount++;
            const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 10000);
            setTimeout(() => {
                if (autoRefreshEnabled) {
                    fetchSlots();
                }
            }, retryDelay);
        });
}

function updateSlotGrid(data) {
    const grid = document.getElementById('slotGrid');

    // Clear grid
    grid.innerHTML = '';

    data.forEach(slot => {
        const div = document.createElement('div');
        div.classList.add('parking-slot');

        let status, statusClass, tooltip = '';
        let displayInfo = '';

        if (slot.session_status === 'pending' || slot.is_reserved) {
            status = 'Reserved';
            statusClass = 'reserved';
            if (slot.vehicle_number) {
                if (slot.user_info && slot.user_info.name) {
                    displayInfo = slot.user_info.name;
                    tooltip = `Owner: ${slot.user_info.name}\nVehicle: ${slot.vehicle_number}`;
                    if (slot.user_info.phone) {
                        tooltip += `\nPhone: ${slot.user_info.phone}`;
                    }
                    if (slot.vehicle_info && (slot.vehicle_info.make || slot.vehicle_info.model)) {
                        tooltip += `\nVehicle: ${slot.vehicle_info.year || ''} ${slot.vehicle_info.make || ''} ${slot.vehicle_info.model || ''}`.trim();
                    }
                } else {
                    displayInfo = slot.vehicle_number;
                    tooltip = `Vehicle: ${slot.vehicle_number} (Unregistered)`;
                }
            }
        } else if (slot.is_occupied) {
            status = 'Occupied';
            statusClass = 'occupied';
            if (slot.vehicle_number) {
                if (slot.user_info && slot.user_info.name) {
                    displayInfo = slot.user_info.name;
                    tooltip = `Owner: ${slot.user_info.name}\nVehicle: ${slot.vehicle_number}`;
                    if (slot.user_info.phone) {
                        tooltip += `\nPhone: ${slot.user_info.phone}`;
                    }
                    if (slot.vehicle_info && (slot.vehicle_info.make || slot.vehicle_info.model)) {
                        tooltip += `\nVehicle: ${slot.vehicle_info.year || ''} ${slot.vehicle_info.make || ''} ${slot.vehicle_info.model || ''}`.trim();
                    }
                } else {
                    displayInfo = slot.vehicle_number;
                    tooltip = `Vehicle: ${slot.vehicle_number} (Unregistered)`;
                }
                if (slot.session_start) {
                    const startTime = new Date(slot.session_start);
                    const duration = Math.floor((new Date() - startTime) / (1000 * 60));
                    tooltip += `\nDuration: ${duration} min`;
                }
            }
        } else {
            status = 'Available';
            statusClass = 'vacant';
            tooltip = 'Click to assign';
        }

        div.classList.add(statusClass);
        div.title = tooltip;

        // Create slot content with user-friendly display
        let slotContent = `<div class="slot-id">${slot.slot_id}</div>`;
        if (displayInfo) {
            slotContent += `<div class="slot-user">${displayInfo}</div>`;
        }
        slotContent += `<div class="slot-status">${status}</div>`;

        div.innerHTML = slotContent;

        // Add click handler for available slots (staff can assign)
        if (statusClass === 'vacant') {
            div.style.cursor = 'pointer';
            div.onclick = () => {
                window.location.href = '/staff/assign/';
            };
        }

        grid.appendChild(div);
    });

    // Update stats
    updateStats(data);
}

function updateStats(data) {
    const stats = {
        available: data.filter(s => !s.is_occupied && !s.is_reserved && s.session_status !== 'pending').length,
        occupied: data.filter(s => s.is_occupied).length,
        reserved: data.filter(s => s.is_reserved || s.session_status === 'pending').length,
        total: data.length
    };

    // Simple stat updates without animations
    updateStatValue('availableCount', stats.available);
    updateStatValue('occupiedCount', stats.occupied);
    updateStatValue('reservedCount', stats.reserved);
    updateStatValue('totalCount', stats.total);
}

function updateStatValue(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = newValue;
    }
}

function updateConnectionStatus(status, responseTime) {
    const indicator = document.getElementById('connectionIndicator') || createConnectionIndicator();
    const now = new Date().toLocaleTimeString();

    connectionStatus = status;

    if (status === 'connected') {
        indicator.className = 'connection-indicator connected';
        indicator.innerHTML = `<i class="fas fa-wifi"></i> Live (${responseTime}ms) - ${now}`;
    } else if (status === 'error') {
        indicator.className = 'connection-indicator error';
        indicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Connection Error - ${now}`;
    } else {
        indicator.className = 'connection-indicator connecting';
        indicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Connecting...`;
    }
}

function createConnectionIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'connectionIndicator';
    indicator.className = 'connection-indicator connecting';

    // Add to dashboard header
    const header = document.querySelector('.card-header h4');
    if (header) {
        header.appendChild(indicator);
    }

    return indicator;
}

function showLoadingIndicator() {
    const indicator = document.getElementById('loadingIndicator') || createLoadingIndicator();
    indicator.style.display = 'inline-block';
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

function createLoadingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'loadingIndicator';
    indicator.className = 'loading-indicator';
    indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';

    const refreshBtn = document.querySelector('button[onclick="fetchSlots()"]');
    if (refreshBtn) {
        refreshBtn.parentNode.insertBefore(indicator, refreshBtn);
    }

    return indicator;
}

function toggleFeed() {
    const videoArea = document.getElementById('videoArea');
    const refreshBtn = document.getElementById('refreshBtn');
    const toggleBtn = event.target;

    if (videoArea.style.display === 'none') {
        videoArea.style.display = 'block';
        refreshBtn.style.display = 'inline-block';
        toggleBtn.innerHTML = '<i class="fas fa-pause"></i> Hide Feed';
        toggleBtn.className = 'btn btn-danger';
    } else {
        videoArea.style.display = 'none';
        refreshBtn.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-play"></i> Show Feed';
        toggleBtn.className = 'btn btn-primary';
    }
}

function refreshFeed() {
    const liveFeed = document.getElementById('liveFeed');
    const currentSrc = liveFeed.src;
    liveFeed.src = '';
    setTimeout(() => {
        liveFeed.src = currentSrc + '?t=' + new Date().getTime();
    }, 100);
}

// Customer approval functions
function approveCustomer(userId) {
    if (confirm('Are you sure you want to approve this customer?')) {
        fetch(`/staff/approve-customer/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while approving the customer.');
        });
    }
}

function rejectCustomer(userId) {
    const reason = prompt('Please provide a reason for rejection (optional):');
    if (reason !== null) {
        fetch(`/staff/reject-customer/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({reason: reason})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while rejecting the customer.');
        });
    }
}

// Auto-refresh stats
setInterval(() => {
    fetch('/api/staff-stats/')
        .then(response => response.json())
        .then(data => {
            // Update stats if needed
            if (data.pending_customers_count !== undefined) {
                const pendingElement = document.querySelector('.stat-number.text-warning');
                if (pendingElement) {
                    pendingElement.textContent = data.pending_customers_count;
                }
            }
        })
        .catch(error => console.error('Error fetching stats:', error));
}, 30000); // Refresh every 30 seconds
{% endblock %}

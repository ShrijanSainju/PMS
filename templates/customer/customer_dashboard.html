{% extends 'base.html' %}
{% load static %}

{% block title %}Customer Dashboard - PMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}

<style>
    .customer-dashboard {
        padding: 2rem 0;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .info-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;

    .session-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .session-card:hover {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .session-details h6 {
        margin-bottom: 0.25rem;
        color: #2c3e50;
    }

    .session-details small {
        color: #6c757d;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-completed {
        background: #d1ecf1;
        color: #0c5460;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .quick-action {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        text-decoration: none;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .quick-action:hover {
        border-color: #17a2b8;
        color: #17a2b8;
        text-decoration: none;
        transform: translateY(-2px);
    }

    .quick-action i {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: block;
    }

</style>
{% endblock %}

{% block content %}
<div class="container customer-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-user"></i> Customer Dashboard</h1>
                <p class="mb-0">Welcome back, {{ user.get_full_name|default:user.username }}! Manage your parking sessions and bookings.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="text-white-50">
                    <small>Last login: {{ user.last_login|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon text-success">
                <i class="fas fa-parking"></i>
            </div>
            <div class="stat-number text-success">{{ available_slots }}</div>
            <div class="stat-label">Available Slots</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon text-info">
                <i class="fas fa-car"></i>
            </div>
            <div class="stat-number text-info">{{ my_active_sessions }}</div>
            <div class="stat-label">My Active Sessions</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon text-primary">
                <i class="fas fa-history"></i>
            </div>
            <div class="stat-number text-primary">{{ my_total_sessions }}</div>
            <div class="stat-label">Total Sessions</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon text-warning">
                <i class="fas fa-rupee-sign"></i>
            </div>
            <div class="stat-number text-warning">₹{{ total_spent }}</div>
            <div class="stat-label">Total Spent</div>
        </div>
    </div>

    <!-- Current Sessions -->
    {% if current_sessions %}
    <div class="info-section">
        <h3><i class="fas fa-car"></i> Current Parking Sessions</h3>
        {% for session in current_sessions %}
        <div class="session-card">
            <div class="session-header">
                <div class="session-details">
                    <h6>{{ session.vehicle_number }}</h6>
                    <small>Slot: {{ session.slot.slot_id }} • Started: {{ session.start_time|date:"M d, Y H:i" }}</small>
                </div>
                <span class="status-badge status-{{ session.status }}">
                    {{ session.get_status_display }}
                </span>
            </div>
            {% if session.status == 'active' %}
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">Current Duration:</small>
                    <p class="mb-0"><strong id="duration-{{ session.id }}">Calculating...</strong></p>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">Estimated Fee:</small>
                    <p class="mb-0"><strong id="fee-{{ session.id }}">₹{{ session.calculate_fee }}</strong></p>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Recent Sessions -->
    <div class="row">
        <div class="col-md-8">
            <div class="info-section">
                <h4><i class="fas fa-history"></i> Recent Parking History</h4>
                {% for session in recent_sessions %}
                <div class="session-card">
                    <div class="session-header">
                        <div class="session-details">
                            <h6>{{ session.vehicle_number }}</h6>
                            <small>
                                Slot: {{ session.slot.slot_id }} •
                                {{ session.start_time|date:"M d, Y H:i" }}
                                {% if session.end_time %}
                                - {{ session.end_time|date:"M d, Y H:i" }}
                                {% endif %}
                            </small>
                        </div>
                        <div>
                            <span class="status-badge status-{{ session.status }}">
                                {{ session.get_status_display }}
                            </span>
                            {% if session.fee %}
                            <br><small class="text-muted">Fee: ₹{{ session.fee }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted text-center">No parking history found.</p>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-4">
            <div class="info-section">
                <h4><i class="fas fa-user-circle"></i> Account Info</h4>
                <div class="mb-3">
                    <strong>Name:</strong> {{ user.get_full_name|default:user.username }}
                </div>
                <div class="mb-3">
                    <strong>Email:</strong> {{ user.email }}
                </div>
                {% if user.userprofile.phone_number %}
                <div class="mb-3">
                    <strong>Phone:</strong> {{ user.userprofile.phone_number }}
                </div>
                {% endif %}
                <div class="mb-3">
                    <strong>Member Since:</strong> {{ user.date_joined|date:"M d, Y" }}
                </div>
                <div class="mb-3">
                    <strong>Status:</strong>
                    <span class="badge bg-success">{{ user.userprofile.get_approval_status_display }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'lookup-session' %}" class="quick-action">
            <i class="fas fa-search"></i>
            <h5>Lookup Vehicle</h5>
            <p>Check vehicle status</p>
        </a>
        <a href="{% url 'auth:profile' %}" class="quick-action">
            <i class="fas fa-user-edit"></i>
            <h5>Edit Profile</h5>
            <p>Update your information</p>
        </a>
        <a href="{% url 'auth:change_password' %}" class="quick-action">
            <i class="fas fa-key"></i>
            <h5>Change Password</h5>
            <p>Update your password</p>
        </a>
        <a href="{% url 'history-log' %}" class="quick-action">
            <i class="fas fa-history"></i>
            <h5>Full History</h5>
            <p>View complete parking history</p>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// Update duration and fee for active sessions
function updateActiveSessions() {
    {% for session in current_sessions %}
    {% if session.status == 'active' %}
    const startTime = new Date('{{ session.start_time|date:"c" }}');
    const now = new Date();
    const duration = Math.floor((now - startTime) / 1000 / 60); // minutes
    const fee = duration * 2; // ₹2 per minute

    const durationElement = document.getElementById('duration-{{ session.id }}');
    const feeElement = document.getElementById('fee-{{ session.id }}');

    if (durationElement) {
        const hours = Math.floor(duration / 60);
        const minutes = duration % 60;
        durationElement.textContent = `${hours}h ${minutes}m`;
    }

    if (feeElement) {
        feeElement.textContent = `₹${fee}`;
    }
    {% endif %}
    {% endfor %}
}

// Update every minute
setInterval(updateActiveSessions, 60000);
updateActiveSessions(); // Initial call
{% endblock %}

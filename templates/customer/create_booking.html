{% extends 'base.html' %}
{% load static %}

{% block title %}Create Booking - PMS{% endblock %}

{% block extra_css %}
<style>
    .booking-form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .form-header {
        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
    }

    .info-card {
        background: #f8f9fa;
        border-left: 4px solid #20c997;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 8px;
    }

    .estimated-fee {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        margin-top: 1.5rem;
    }

    .form-group label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .btn-create-booking {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-create-booking:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="booking-form-container">
        <div class="form-header">
            <h1><i class="fas fa-calendar-plus"></i> Create New Booking</h1>
            <p class="mb-0">Reserve your parking spot in advance</p>
        </div>

        <!-- Info Cards -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="info-card">
                    <h6><i class="fas fa-parking"></i> Available Slots</h6>
                    <h3 class="text-success mb-0">{{ available_slots_count }}</h3>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-card">
                    <h6><i class="fas fa-car"></i> Your Vehicles</h6>
                    <h3 class="text-primary mb-0">{{ user_vehicles.count }}</h3>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <form method="post" id="bookingForm">
            {% csrf_token %}
            
            <div class="form-group mb-3">
                <label for="{{ form.vehicle.id_for_label }}">
                    <i class="fas fa-car"></i> Select Vehicle
                </label>
                {{ form.vehicle }}
                {% if form.vehicle.errors %}
                    <div class="text-danger mt-1">{{ form.vehicle.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">{{ form.vehicle.help_text }}</small>
            </div>

            <div class="form-group mb-3">
                <label for="{{ form.scheduled_arrival.id_for_label }}">
                    <i class="fas fa-clock"></i> Scheduled Arrival
                </label>
                {{ form.scheduled_arrival }}
                {% if form.scheduled_arrival.errors %}
                    <div class="text-danger mt-1">{{ form.scheduled_arrival.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">{{ form.scheduled_arrival.help_text }}</small>
            </div>

            <div class="form-group mb-3">
                <label for="{{ form.expected_duration.id_for_label }}">
                    <i class="fas fa-hourglass-half"></i> Expected Duration (minutes)
                </label>
                {{ form.expected_duration }}
                {% if form.expected_duration.errors %}
                    <div class="text-danger mt-1">{{ form.expected_duration.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">{{ form.expected_duration.help_text }}</small>
            </div>

            <div class="form-group mb-3">
                <label for="{{ form.notes.id_for_label }}">
                    <i class="fas fa-sticky-note"></i> Special Requests (Optional)
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="text-danger mt-1">{{ form.notes.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">{{ form.notes.help_text }}</small>
            </div>

            <!-- Estimated Fee Display -->
            <div class="estimated-fee">
                <h5 class="mb-2">Estimated Parking Fee</h5>
                <h2 id="estimatedFee">₹0</h2>
                <small>Based on ₹2 per minute</small>
            </div>

            <!-- Form Errors -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger mt-3">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-create-booking flex-grow-1">
                    <i class="fas fa-check"></i> Confirm Booking
                </button>
                <a href="{% url 'customer_bookings' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>

        <!-- Important Notes -->
        <div class="alert alert-info mt-4">
            <h6><i class="fas fa-info-circle"></i> Important Information</h6>
            <ul class="mb-0">
                <li>Bookings must be made at least 1 hour in advance</li>
                <li>You can book up to 7 days in advance</li>
                <li>Arrive within 30 minutes of your scheduled time</li>
                <li>You can cancel up to 1 hour before your scheduled arrival</li>
                <li>No-shows will result in automatic cancellation</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const durationInput = document.getElementById('{{ form.expected_duration.id_for_label }}');
    const feeDisplay = document.getElementById('estimatedFee');
    
    function updateFee() {
        const duration = parseInt(durationInput.value) || 0;
        const pricePerMinute = {{ settings.price_per_minute|default:2 }};
        const fee = duration * pricePerMinute;
        feeDisplay.textContent = `₹${fee}`;
    }
    
    if (durationInput) {
        durationInput.addEventListener('input', updateFee);
        updateFee(); // Initial calculation
    }
    
    // Set minimum datetime to 1 hour from now
    const arrivalInput = document.getElementById('{{ form.scheduled_arrival.id_for_label }}');
    if (arrivalInput) {
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const minDateTime = now.toISOString().slice(0, 16);
        arrivalInput.setAttribute('min', minDateTime);
        
        // Set maximum to 7 days from now
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 7);
        const maxDateTime = maxDate.toISOString().slice(0, 16);
        arrivalInput.setAttribute('max', maxDateTime);
    }
});
</script>
{% endblock %}
